<div class="dashboard-container">
  <main class="dashboard-content">
    <div class="content-wrapper">
      <!-- Profile Card -->
      <div class="card profile-card">
        <div class="card-header">
          <h2 class="card-title">Profile Settings</h2>
          <p class="card-description">Customize your public profile</p>
        </div>

        <!-- Theme Editor Section Removed -->

        <div class="card-content">
          <div class="profile-info">
            <!-- Profile Picture Upload -->
            <div class="info-group">
              <label class="form-label">Profile Picture</label>
              <div class="avatar-upload-wrapper">
                <div
                  class="avatar-preview"
                  [style.background-image]="
                    avatarPreview ? 'url(' + avatarPreview + ')' : 'none'
                  "
                  [class.has-image]="avatarPreview"
                  (click)="profileInput.click()"
                  title="Click to upload/crop"
                >
                  <span *ngIf="!avatarPreview">{{
                    (displayName || currentUser?.username || "U")
                      .charAt(0)
                      .toUpperCase()
                  }}</span>
                </div>
                <div class="avatar-upload-controls">
                  <input
                    type="file"
                    #profileInput
                    (change)="onFileSelected($event, 'profile')"
                    accept="image/*"
                    hidden
                  />
                  <div class="upload-buttons">
                    <button
                      type="button"
                      class="btn btn-secondary btn-sm"
                      (click)="profileInput.click()"
                    >
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        width="16"
                        height="16"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        style="margin-right: 0.5rem"
                      >
                        <path
                          d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"
                        ></path>
                        <polyline points="17 8 12 3 7 8"></polyline>
                        <line x1="12" y1="3" x2="12" y2="15"></line>
                      </svg>
                      Choose Image
                    </button>
                    <button
                      type="button"
                      *ngIf="avatarPreview || croppedImage"
                      class="btn btn-ghost btn-sm"
                      (click)="removeAvatar()"
                    >
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        width="16"
                        height="16"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        style="margin-right: 0.5rem"
                      >
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                      </svg>
                      Remove
                    </button>
                  </div>
                  <p class="upload-hint">JPG, PNG or GIF. Max 5MB.</p>
                </div>
              </div>
            </div>

            <div class="info-group">
              <label for="username" class="form-label"
                >Profile Personalised Url</label
              >
              <div class="username-input-wrapper">
                <div class="username-prefix">yoursite.com/</div>
                <input
                  type="text"
                  id="username"
                  [(ngModel)]="username"
                  (input)="onUsernameChange()"
                  name="username"
                  class="form-input username-input"
                  placeholder="username"
                  minlength="3"
                  maxlength="16"
                  [class.error]="
                    username &&
                    !usernameAvailable &&
                    username !== currentUser?.username
                  "
                />
                <div *ngIf="checkingUsername" class="checking-spinner">⏳</div>
              </div>
              <p
                *ngIf="username && username !== currentUser?.username"
                class="info-hint"
              >
                Your profile URL: <strong>{{ getProfileUrl() }}</strong>
              </p>
              <p
                *ngIf="usernameError && username !== currentUser?.username"
                class="form-error"
              >
                {{ usernameError }}
              </p>
              <p
                *ngIf="
                  username &&
                  username !== currentUser?.username &&
                  usernameAvailable &&
                  !usernameError
                "
                class="form-success"
              >
                ✓ Username available!
              </p>
            </div>

            <div class="info-group">
              <label for="displayName" class="form-label">Display Name</label>
              <input
                type="text"
                id="displayName"
                [(ngModel)]="displayName"
                name="displayName"
                class="form-input"
                placeholder="Your Name"
              />
            </div>

            <div class="info-group">
              <label for="bio" class="form-label">Bio</label>
              <textarea
                id="bio"
                [(ngModel)]="bio"
                name="bio"
                class="form-textarea"
                placeholder="Tell visitors about yourself..."
                rows="3"
              ></textarea>
            </div>

            <button
              (click)="updateProfile()"
              class="btn btn-primary"
              [disabled]="profileLoading"
            >
              {{ profileLoading ? "Saving..." : "Save Profile" }}
            </button>
          </div>
        </div>
      </div>

      <!-- Appearance / Theme Card -->
      <div class="card appearance-card">
        <div class="card-header">
          <h2 class="card-title">Appearance</h2>
          <p class="card-description">Customize your page theme and style</p>
        </div>
        <div class="card-content">
          <app-color-picker></app-color-picker>
        </div>
      </div>

      <!-- Add New Link Card -->
      <div class="card" id="link-form-card">
        <div class="card-header">
          <h2 class="card-title">
            {{ editingLink ? "Edit Link" : "Add New Link" }}
          </h2>
          <p class="card-description">
            {{
              editingLink
                ? "Update your link details"
                : "Create a new link to share"
            }}
          </p>
        </div>
        <div class="card-content">
          <form (ngSubmit)="saveLink()">
            <!-- Live Preview Section -->
            <div class="form-group">
              <label class="form-label">Live Preview & Icon</label>
              <div class="live-preview-container">
                <!-- Mock Link Card -->
                <div class="preview-card" [class.no-icon]="!formData.iconUrl">
                  <!-- Icon Area (Clickable to upload) -->
                  <div
                    class="preview-icon-area"
                    (click)="iconInput.click()"
                    title="Click to upload icon"
                  >
                    <img
                      *ngIf="formData.iconUrl"
                      [src]="formData.iconUrl"
                      class="preview-icon-img"
                      alt="Icon"
                    />
                    <div
                      *ngIf="!formData.iconUrl"
                      class="preview-icon-placeholder"
                    >
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        width="24"
                        height="24"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                      >
                        <rect
                          x="3"
                          y="3"
                          width="18"
                          height="18"
                          rx="2"
                          ry="2"
                        ></rect>
                        <circle cx="8.5" cy="8.5" r="1.5"></circle>
                        <polyline points="21 15 16 10 5 21"></polyline>
                      </svg>
                      <span>Add Icon</span>
                    </div>
                    <div class="preview-icon-overlay">
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        width="16"
                        height="16"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="white"
                        stroke-width="2"
                      >
                        <path
                          d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"
                        ></path>
                        <path
                          d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"
                        ></path>
                      </svg>
                    </div>
                  </div>

                  <!-- Content -->
                  <div class="preview-content">
                    <div class="preview-title">
                      {{ formData.title || "Link Title" }}
                    </div>
                    <div class="preview-url">
                      {{ formData.url || "https://your-link.com" }}
                    </div>
                  </div>

                  <!-- Arrow (Visual) -->
                  <div class="preview-arrow">
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      width="20"
                      height="20"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                    >
                      <polyline points="9 18 15 12 9 6"></polyline>
                    </svg>
                  </div>
                </div>

                <!-- Icon Actions Toolbar -->
                <div class="preview-actions">
                  <button
                    type="button"
                    class="btn-xs btn-secondary"
                    (click)="fetchFavicon()"
                    title="Auto-fetch from URL"
                  >
                    Auto-Fetch
                  </button>
                  <button
                    type="button"
                    *ngIf="formData.iconUrl"
                    class="btn-xs btn-danger"
                    (click)="removeIcon()"
                    title="Remove"
                  >
                    Remove
                  </button>
                  <!-- Hidden Input -->
                  <input
                    #iconInput
                    type="file"
                    hidden
                    accept="image/*"
                    (change)="onFileSelected($event, 'link', editingLink?._id)"
                  />
                </div>
              </div>
            </div>

            <div class="form-group">
              <label for="title" class="form-label">Link Title</label>
              <input
                type="text"
                id="title"
                [(ngModel)]="formData.title"
                name="title"
                required
                class="form-input"
                placeholder="My Website"
              />
            </div>

            <div class="form-group">
              <label for="url" class="form-label">Link URL</label>
              <input
                type="url"
                id="url"
                [(ngModel)]="formData.url"
                name="url"
                required
                class="form-input"
                placeholder="https://example.com"
              />
            </div>

            <div class="form-group">
              <label class="form-label">Schedule Link (Optional)</label>
              <p class="form-hint" style="margin-bottom: 1rem">
                Set when this link should be visible on your profile
              </p>

              <div class="scheduling-fields">
                <div class="form-subgroup">
                  <label for="scheduledStart" class="form-label-sm"
                    >Start Date & Time</label
                  >
                  <input
                    type="datetime-local"
                    id="scheduledStart"
                    [(ngModel)]="formData.scheduledStart"
                    name="scheduledStart"
                    class="form-input"
                    min="2000-01-01T00:00"
                    max="2099-12-31T23:59"
                  />
                </div>

                <div class="form-subgroup">
                  <label for="scheduledEnd" class="form-label-sm"
                    >End Date & Time</label
                  >
                  <input
                    type="datetime-local"
                    id="scheduledEnd"
                    [(ngModel)]="formData.scheduledEnd"
                    name="scheduledEnd"
                    class="form-input"
                    min="2000-01-01T00:00"
                    max="2099-12-31T23:59"
                  />
                </div>
              </div>
              <p class="form-hint">
                Leave empty for link to be always active. Times are in your
                local timezone.
              </p>
            </div>

            <button
              type="submit"
              class="btn btn-primary btn-full"
              [disabled]="loading"
            >
              <svg
                *ngIf="!editingLink"
                xmlns="http://www.w3.org/2000/svg"
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
                style="margin-right: 0.5rem"
              >
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
              </svg>
              {{
                loading ? "Saving..." : editingLink ? "Update Link" : "Add Link"
              }}
            </button>
            <button
              *ngIf="editingLink"
              type="button"
              (click)="cancelEdit()"
              class="btn btn-secondary btn-full"
              style="margin-top: 0.5rem"
            >
              Cancel
            </button>
          </form>
        </div>
      </div>

      <!-- Links List Card -->
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">Your Links</h2>
          <p class="card-description">
            {{ links.length }} link{{ links.length !== 1 ? "s" : "" }} total
          </p>
        </div>
        <div class="card-content">
          <div *ngIf="links.length === 0" class="empty-state">
            <p>No links yet. Add your first link above!</p>
          </div>

          <div class="links-list" *ngIf="links.length > 0">
            <div
              *ngFor="let link of links; let i = index"
              class="link-item"
              [class.link-inactive]="
                (link.scheduledStart || link.scheduledEnd) &&
                !isLinkScheduledActive(link)
              "
              draggable="true"
              (dragstart)="onDragStart($event, i)"
              (dragover)="onDragOver($event)"
              (drop)="onDrop($event, i)"
              (dragend)="onDragEnd($event)"
            >
              <!-- Primary Row: Always Visible, Horizontal -->
              <div class="link-main-row">
                <!-- 1. Drag Handle -->
                <div class="drag-handle-wrapper">
                  <svg
                    class="drag-handle"
                    xmlns="http://www.w3.org/2000/svg"
                    width="20"
                    height="20"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <circle cx="9" cy="5" r="1"></circle>
                    <circle cx="9" cy="12" r="1"></circle>
                    <circle cx="9" cy="19" r="1"></circle>
                    <circle cx="15" cy="5" r="1"></circle>
                    <circle cx="15" cy="12" r="1"></circle>
                    <circle cx="15" cy="19" r="1"></circle>
                  </svg>
                </div>

                <!-- 2. Content Wrapper (Icon + Text) -->
                <div class="link-content-wrapper">
                  <!-- Icon -->
                  <div class="link-icon-preview">
                    <img
                      *ngIf="link.iconUrl"
                      [src]="link.iconUrl"
                      [alt]="link.title"
                      class="icon-img"
                    />
                    <div *ngIf="!link.iconUrl" class="icon-placeholder">
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        width="16"
                        height="16"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                      >
                        <path
                          d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"
                        ></path>
                        <path
                          d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"
                        ></path>
                      </svg>
                    </div>
                  </div>

                  <!-- Info (Title, URL, Meta) -->
                  <div class="link-info">
                    <h4 class="link-title">
                      {{ link.title }}
                      <!-- Status Dot for All Links -->
                      <span
                        class="status-dot"
                        [class.active]="
                          (!link.scheduledStart && !link.scheduledEnd) ||
                          isLinkScheduledActive(link)
                        "
                        [title]="
                          (!link.scheduledStart && !link.scheduledEnd) ||
                          isLinkScheduledActive(link)
                            ? 'Active'
                            : 'Inactive'
                        "
                      >
                      </span>
                    </h4>
                    <a [href]="link.url" target="_blank" class="link-url">{{
                      link.url
                    }}</a>

                    <div class="link-meta-row">
                      <span class="link-stats"
                        >{{ link.clicks || 0 }} clicks</span
                      >

                      <!-- Toggle Button (Only if schedule exists) -->
                      <button
                        *ngIf="link.scheduledStart || link.scheduledEnd"
                        type="button"
                        class="btn-mobile-details"
                        (click)="toggleLinkDetails(link._id!)"
                      >
                        {{
                          isDetailsExpanded(link._id!)
                            ? "Hide Info"
                            : "Show Info"
                        }}
                      </button>
                    </div>

                    <!-- Expanded Details (Nested inside link-info) -->
                    <div
                      class="link-details-row"
                      *ngIf="isDetailsExpanded(link._id!)"
                    >
                      <div class="schedule-info-block">
                        <span class="schedule-label">Start:</span>
                        <span class="schedule-val">{{
                          link.scheduledStart
                            ? (link.scheduledStart | date : "short")
                            : "—"
                        }}</span>
                      </div>
                      <div class="schedule-info-block">
                        <span class="schedule-label">End:</span>
                        <span class="schedule-val">{{
                          link.scheduledEnd
                            ? (link.scheduledEnd | date : "short")
                            : "—"
                        }}</span>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- 3. Actions (Right) -->
                <div class="link-actions">
                  <button
                    (click)="editLink(link)"
                    class="btn-icon"
                    title="Edit"
                  >
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      width="16"
                      height="16"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                    >
                      <path
                        d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"
                      ></path>
                      <path
                        d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"
                      ></path>
                    </svg>
                  </button>
                  <button
                    (click)="deleteLink(link._id!)"
                    class="btn-icon btn-icon-danger"
                    title="Delete"
                  >
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      width="16"
                      height="16"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                    >
                      <polyline points="3 6 5 6 21 6"></polyline>
                      <path
                        d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"
                      ></path>
                    </svg>
                  </button>
                </div>
              </div>

              <!-- Secondary Row: Expandable Details -->
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Image Cropper Modal -->
  <div class="modal-overlay" *ngIf="showCropperModal" (click)="cancelCrop()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Crop Your Image</h3>
        <button class="btn-close" (click)="cancelCrop()">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="24"
            height="24"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
          >
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <image-cropper
          [imageChangedEvent]="imageChangedEvent"
          [maintainAspectRatio]="true"
          [aspectRatio]="1"
          [roundCropper]="true"
          [resizeToWidth]="300"
          format="png"
          (imageCropped)="imageCropped($event)"
          (imageLoaded)="imageLoaded()"
          (cropperReady)="cropperReady()"
          (loadImageFailed)="loadImageFailed()"
        ></image-cropper>
      </div>
      <div class="modal-footer">
        <button class="btn btn-ghost" (click)="cancelCrop()">Cancel</button>
        <button class="btn btn-primary" (click)="applyCrop()">Apply</button>
      </div>
    </div>
  </div>
</div>
