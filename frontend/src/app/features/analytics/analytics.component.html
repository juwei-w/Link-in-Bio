<div class="analytics-container">
  <!-- Page Header with Date Filter -->
  <div class="analytics-header">
    <div class="header-text">
      <h1 class="page-title">Analytics Dashboard</h1>
      <p class="page-subtitle">Track your link performance and engagement</p>
    </div>
    <div class="date-filter">
      <label for="days-select">Time Range:</label>
      <select id="days-select" [(ngModel)]="days" (change)="onDaysChange()" class="days-select">
        <option *ngFor="let d of dateRanges" [ngValue]="d">
          {{ d === 0 ? 'All Time' : 'Last ' + d + ' Days' }}
        </option>
      </select>
    </div>
  </div>

  <!-- Loading State -->
  <div *ngIf="loading" class="loading">
    <div class="loading-spinner">
      <svg width="48" height="48" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
        <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" fill="none" opacity="0.25" />
        <path d="M12 2a10 10 0 0 1 10 10" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" />
      </svg>
    </div>
    <p>Loading analytics...</p>
  </div>

  <!-- Content -->
  <div *ngIf="!loading" class="analytics-content">
    <!-- Summary Cards -->
    <div class="summary-grid">
      <div class="summary-card card">
        <div class="summary-icon">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
          </svg>
        </div>
        <div class="summary-details">
          <h3 class="summary-label">Total Clicks</h3>
          <p class="summary-value">{{ summary.totalClicks }}</p>
        </div>
      </div>

      <div class="summary-card card">
        <div class="summary-icon">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="10"></circle>
            <polyline points="12 6 12 12 16 14"></polyline>
          </svg>
        </div>
        <div class="summary-details">
          <h3 class="summary-label">Peak Activity</h3>
          <p class="summary-value-small">{{ peakTimeDisplay }}</p>
          <p class="summary-subtext" *ngIf="peakTimeDayParts">{{ peakTimeDayParts }}</p>
        </div>
      </div>

      <div class="summary-card card">
        <div class="summary-icon">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
            <circle cx="12" cy="10" r="3"></circle>
          </svg>
        </div>
        <div class="summary-details">
          <h3 class="summary-label">Top Location</h3>
          <p class="summary-value-small">{{ topCity }}</p>
          <p class="summary-subtext">{{ topCountry }}</p>
        </div>
      </div>

      <div class="summary-card card">
        <div class="summary-icon">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" y1="20" x2="18" y2="10"></line>
            <line x1="12" y1="20" x2="12" y2="4"></line>
            <line x1="6" y1="20" x2="6" y2="14"></line>
          </svg>
        </div>
        <div class="summary-details">
          <h3 class="summary-label">Avg. Clicks/Link</h3>
          <p class="summary-value">{{ summary.avgClicksPerLink }}</p>
        </div>
      </div>
    </div>

    <!-- Links Performance -->
    <div class="performance-section card">
      <div class="section-header">
        <h2 class="section-title">Link Performance</h2>
        <p class="section-subtitle">Click distribution across all your links</p>
      </div>

      <div *ngIf="links.length === 0" class="empty-state">
        <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none"
          stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="12" cy="12" r="10"></circle>
          <line x1="12" y1="8" x2="12" y2="12"></line>
          <line x1="12" y1="16" x2="12.01" y2="16"></line>
        </svg>
        <p>No links yet. Create your first link in the dashboard!</p>
      </div>

      <div *ngIf="links.length > 0" class="links-list">
        <div *ngFor="let link of links; let i = index" class="link-item card clickable"
          (click)="toggleLinkDetails(link._id!)" [class.expanded]="expandedLinkId === link._id">

          <div class="link-header">
            <div class="link-rank">{{ i + 1 }}</div>
            <div class="link-info-main">
              <h3 class="link-title">{{ link.title }}</h3>
              <p class="link-url">{{ link.url }}</p>
            </div>
            <div class="link-mini-stats">
              <span class="stat-clicks">{{ link.clicks || 0 }} clicks</span>
              <svg class="chevron" [class.rotated]="expandedLinkId === link._id" xmlns="http://www.w3.org/2000/svg"
                width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round">
                <polyline points="6 9 12 15 18 9"></polyline>
              </svg>
            </div>
          </div>

          <!-- Expanded Details -->
          <div class="link-details" *ngIf="expandedLinkId === link._id">
            <div *ngIf="loadingLinkAnalytics" class="loading-small">
              Loading details...
            </div>

            <div *ngIf="!loadingLinkAnalytics && linkAnalytics" class="details-grid">
              <!-- Specific metrics for this link would go here (e.g., mini chart) -->
              <div class="detail-block">
                <h4>Today's Clicks</h4>
                <p class="detail-value">{{ linkAnalytics.todayClicks || 0 }}</p>
              </div>
              <div class="detail-block">
                <h4>Total Clicks</h4>
                <p class="detail-value">{{ linkAnalytics.timeRange?.clicksInRange ?? link.clicks }}</p>
              </div>
              <div class="detail-block">
                <h4>Click Through Rate</h4>
                <p class="detail-value text-sm">{{ getLinkCtr(linkAnalytics.totalClicks || link.clicks) }}%</p>
              </div>
              <div class="detail-block">
                <h4>Status</h4>
                <p class="detail-value text-sm" [class.text-green]="link.isActive" [class.text-gray]="!link.isActive">
                  {{ link.isActive ? 'Active' : 'Inactive' }}
                </p>
              </div>
              <div class="detail-block">
                <h4>Created At</h4>
                <p class="detail-value text-sm">{{ link.createdAt | date:'mediumDate' }}</p>
              </div>
              <div class="detail-block">
                <h4>Last Clicked</h4>
                <p class="detail-value text-sm">
                  {{ link.lastClickedAt ? (link.lastClickedAt | date:'mediumDate') : 'Never' }}
                </p>
              </div>
            </div>
          </div>

        </div>
      </div>
    </div>

    <!-- Overview Analytics -->
    <div *ngIf="overview" class="overview-grid">
      <!-- Time Series Chart -->
      <div class="card chart-card full-width">
        <div class="section-header">
          <h2 class="section-title">Traffic Over Time</h2>
          <p class="section-subtitle">Daily clicks for the last {{ days }} days</p>
        </div>
        <div class="chart-container">
          <canvas id="timeSeriesCanvas" #timeSeriesCanvas></canvas>
        </div>
      </div>

      <!-- Audience Insights Row -->
      <div class="charts-row">

        <!-- Traffic Sources -->
        <div class="card chart-card">
          <div class="section-header">
            <h2 class="section-title">Traffic Sources</h2>
            <p class="section-subtitle">Top referrers (Socials, Direct)</p>
          </div>
          <div class="chart-container chart-small">
            <canvas id="referrersCanvas" #platformsCanvas></canvas> <!-- Re-using canvas ref but for referrers now -->
          </div>
          <div *ngIf="!overview.topReferrers || overview.topReferrers.length === 0" class="empty-state-small">
            No referrer data yet
          </div>
        </div>

        <!-- Start Device Chart -->
        <div class="card chart-card">
          <div class="section-header">
            <h2 class="section-title">Devices</h2>
            <p class="section-subtitle">Mobile vs Desktop</p>
          </div>
          <div class="chart-container chart-small">
            <canvas id="devicesCanvas" #devicesCanvas></canvas>
          </div>
          <div *ngIf="!overview.devices || overview.devices.length === 0" class="empty-state-small">
            No device data yet
          </div>
        </div>
        <!-- End Device Chart -->

        <!-- Geographic Distribution -->
        <div class="card chart-card">
          <div class="section-header">
            <h2 class="section-title">Top Locations</h2>
            <p class="section-subtitle">Cities & Countries</p>
          </div>

          <div class="chart-container chart-small">
            <canvas id="locationsCanvas" #locationsCanvas></canvas>
          </div>
          <div *ngIf="!overview.topCountries?.length" class="empty-state-small">
            No location data
          </div>
        </div>

      </div>
    </div>
  </div>
</div>